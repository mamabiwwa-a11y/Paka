name: Linux_GUI_RDP_V6
on:
  workflow_dispatch:

jobs:
  linux-gui:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
      - name: Update and Install Desktop Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xrdp xorg dbus-x11 x11-xserver-utils
          sudo systemctl enable xrdp
          sudo service xrdp start

      - name: Create User and Configure GUI Session
        run: |
          sudo useradd -m -s /bin/bash runneradmin
          echo "runneradmin:password123" | sudo chpasswd
          sudo usermod -aG sudo,ssl-cert runneradmin
          
          sudo bash -c 'cat > /home/runneradmin/start_gui.sh << "EOFSCRIPT"
          #!/bin/bash
          
          export XDG_RUNTIME_DIR=/tmp/runtime-$(id -u)
          
          if [ ! -d "$XDG_RUNTIME_DIR" ] || [ ! -O "$XDG_RUNTIME_DIR" ]; then
            rm -rf "$XDG_RUNTIME_DIR" 2>/dev/null
            mkdir -p "$XDG_RUNTIME_DIR"
            chmod 700 "$XDG_RUNTIME_DIR"
          fi
          
          if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
             eval $(dbus-launch --sh-syntax --exit-with-session)
          fi
          
          export XDG_SESSION_TYPE=x11
          export XDG_CURRENT_DESKTOP=XFCE
          export XDG_CONFIG_DIRS=/etc/xdg
          export XDG_DATA_DIRS=/usr/local/share:/usr/share
          export XDG_CONFIG_HOME="$HOME/.config"
          export XDG_CACHE_HOME="$HOME/.cache"
          export XDG_DATA_HOME="$HOME/.local/share"
          
          mkdir -p "$XDG_CONFIG_HOME" "$XDG_CACHE_HOME" "$XDG_DATA_HOME"
          
          exec dbus-run-session -- xfce4-session
          EOFSCRIPT'
          
          sudo chmod +x /home/runneradmin/start_gui.sh
          sudo chown runneradmin:runneradmin /home/runneradmin/start_gui.sh
          
          sudo -u runneradmin bash -c 'echo "exec /home/runneradmin/start_gui.sh" > /home/runneradmin/.xsession'
          sudo chmod +x /home/runneradmin/.xsession
          
          sudo bash -c 'cat > /etc/xrdp/startwm.sh << "EOFXRDP"
          #!/bin/sh
          
          if [ -r /etc/profile ]; then
              . /etc/profile
          fi
          
          if [ -r $HOME/.profile ]; then
              . $HOME/.profile
          fi
          
          if [ -x $HOME/.xsession ]; then
              exec $HOME/.xsession
          else
              exec /home/runneradmin/start_gui.sh
          fi
          EOFXRDP'
          
          sudo chmod +x /etc/xrdp/startwm.sh
          sudo service xrdp restart
          
          echo "=========================================="
          echo "Username: runneradmin"
          echo "Password: password123"
          echo "=========================================="

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=linux-manual-fix --ssh

      - name: Display Connection Info
        run: |
          echo "=========================================="
          echo "Tailscale IP:"
          tailscale ip -4
          echo ""
          echo "Connect with RDP:"
          echo "  Address: $(tailscale ip -4):3389"
          echo "  Username: runneradmin"
          echo "  Password: password123"
          echo "=========================================="

      - name: Keep Alive Loop
        run: |
          echo "Desktop running. Cancel workflow to stop."
          while true; do
            sleep 300
          done
